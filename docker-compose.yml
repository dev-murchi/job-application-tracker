# Production-grade Docker Compose configuration
# Usage:
#   Development:                  docker compose --profile dev --env-file .env.dev up
#
#   Testing (Backend):            docker compose --profile backend-test --env-file .env.test up -d
#   Testing (unit+integration):   docker exec -it <backend-container-name> npm run test 
#   Testing (unit):               docker exec -it <backend-container-name> npm run test:unit
#   Testing (integration):        docker exec -it <backend-container-name> npm run test:integration
#
#   Testing (Frontend):           docker compose --profile frontend-test --env-file .env.test up -d
#   Testing (unit):               docker exec -it <frontend-container-name> npm run test
#
#   Production:                   docker compose --profile production --env-file .env.prod up

services:
  # ===== MongoDB Database (Development) =====
  mongodb-dev:
    image: mongo:8.0
    restart: unless-stopped
    profiles: ["dev"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    expose:
      - "27017"
    networks:
      - backend-network
    volumes:
      - mongodb-data-dev:/data/db
      - mongodb-config-dev:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== MongoDB Database (Test) =====
  mongodb-test:
    image: mongo:8.0
    restart: "no"
    profiles: ["backend-test"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    expose:
      - "27017"
    networks:
      - backend-network
    volumes:
      - mongodb-data-test:/data/db
      - mongodb-config-test:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "2"

  # ===== MongoDB Database (Production) =====
  mongodb-prod:
    image: mongo:8.0
    restart: always
    profiles: ["production"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
    expose:
      - "27017"
    networks:
      - backend-network
    volumes:
      - mongodb-data-prod:/data/db
      - mongodb-config-prod:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping').ok", "--quiet"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
        compress: "true"


  # ===== Backend API (Development) =====
  backend-dev:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: dev
    restart: unless-stopped
    profiles: ["dev"]
    environment:
      NODE_ENV: ${NODE_ENV}
      SERVER_PORT: ${SERVER_PORT}
      MONGO_URL: ${MONGO_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_LIFETIME: ${JWT_LIFETIME}
      CORS_ORIGIN: ${CORS_ORIGIN}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS}
      LOG_LEVEL: ${LOG_LEVEL}
    ports:
      - "${HOST_PORT}:${SERVER_PORT}"
    networks:
      - backend-network
      - frontend-network
    volumes:
      - ./backend:/usr/src/app:cached
      - backend-node-modules-dev:/usr/src/app/node_modules
      - ./logs/backend:/usr/src/app/logs
    depends_on:
      mongodb-dev:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${SERVER_PORT}/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== Backend API (Test) =====
  backend-test:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: test
    profiles: ["backend-test"]
    restart: "no"
    environment:
      NODE_ENV: ${NODE_ENV}
      SERVER_PORT: ${SERVER_PORT}
      MONGO_URL: ${MONGO_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_LIFETIME: ${JWT_LIFETIME}
      CORS_ORIGIN: ${CORS_ORIGIN}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS}
      LOG_LEVEL: ${LOG_LEVEL}
      REQUEST_SIZE_LIMIT: ${REQUEST_SIZE_LIMIT}
    networks:
      - backend-network
    volumes:
      - ./backend:/usr/src/app
      - backend-node-modules-test:/usr/src/app/node_modules
      - ./coverage/backend:/usr/src/app/coverage
      - ./logs/backend-test:/usr/src/app/logs
    depends_on:
      mongodb-test:
        condition: service_healthy
    command: ["tail", "-f", "/dev/null"]
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== Backend API (Production) =====
  backend-prod:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: production
    restart: always
    profiles: ["production"]
    environment:
      NODE_ENV: ${NODE_ENV}
      SERVER_PORT: ${SERVER_PORT}
      MONGO_URL: ${MONGO_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_LIFETIME: ${JWT_LIFETIME}
      CORS_ORIGIN: ${CORS_ORIGIN}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS}
      LOG_LEVEL: ${LOG_LEVEL}
      REQUEST_SIZE_LIMIT: ${REQUEST_SIZE_LIMIT}
    expose:
      - ${SERVER_PORT}
    networks:
      - backend-network
    depends_on:
      mongodb-prod:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:${SERVER_PORT}/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
        compress: "true"

  # ===== Frontend (Development) =====
  frontend-dev:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: dev
    restart: unless-stopped
    profiles: ["dev"]
    environment:
      NODE_ENV: development
    ports:
      - "${FRONTEND_PORT}:4200"
    networks:
      - frontend-network
    volumes:
      - ./frontend:/usr/src/app:cached
      - frontend-node-modules-dev:/usr/src/app/node_modules
      - frontend-angular-cache:/usr/src/app/.angular
    depends_on:
      - backend-dev
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4200"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== Frontend (Test) =====
  frontend-test:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: test
    profiles: ["frontend-test"]
    environment:
      NODE_ENV: test
    networks:
      - frontend-network
    volumes:
      - ./frontend:/usr/src/app
      - frontend-node-modules-test:/usr/src/app/node_modules
      - ./coverage/frontend:/usr/src/app/coverage
    command: ["tail", "-f", "/dev/null"]
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ===== Frontend (Production) =====
  frontend-prod:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: production
    restart: always
    profiles: ["production"]
    ports:
      - "${NGINX_HTTP_PORT}:80"
      - "${NGINX_HTTPS_PORT}:443"
    networks:
      - backend-network
      - frontend-network
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d/app.conf:/etc/nginx/conf.d/app.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./logs/nginx:/var/log/nginx
    depends_on:
      backend-prod:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
        compress: "true"

# ===== Networks =====
networks:
  backend-network:
    driver: bridge
    name: jobs-tracker-backend
  frontend-network:
    driver: bridge
    name: jobs-tracker-frontend

# ===== Volumes =====
volumes:
  mongodb-data-dev:
    driver: local
  mongodb-config-dev:
    driver: local
  mongodb-data-test:
    driver: local
  mongodb-config-test:
    driver: local
  mongodb-data-prod:
    driver: local
  mongodb-config-prod:
    driver: local
  
  backend-node-modules-dev:
    driver: local
  backend-node-modules-test:
    driver: local
  
  frontend-node-modules-dev:
    driver: local
  frontend-node-modules-test:
    driver: local
  frontend-angular-cache:
    driver: local
