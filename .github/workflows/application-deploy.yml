name: Application Deploy
on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/application-deploy.yml'

permissions:
  packages: write
  contents: read

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changes in the services
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'

  backend-delivery:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    uses: ./.github/workflows/backend-cd.yml
    secrets: inherit
    with:
      caller_event: 'deploy'

  frontend-delivery:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    uses: ./.github/workflows/frontend-cd.yml
    secrets: inherit
    with:
      caller_event: 'deploy'

  normalize:
    name: Normalize Published Images
    needs: [changes, backend-delivery, frontend-delivery]
    if: |
      always() &&
      needs.backend-delivery.result != 'failure' &&
      needs.frontend-delivery.result != 'failure'
    runs-on: ubuntu-latest
    outputs:
      backend_image: ${{ steps.set-outputs.outputs.backend_image }}
      frontend_image: ${{ steps.set-outputs.outputs.frontend_image }}
      deploy_required: ${{ steps.set-outputs.outputs.deploy_required }}
    steps:
      - name: Set outputs
        id: set-outputs
        env:
          BACKEND_PUB: ${{ needs.backend-delivery.outputs.published_image }}
          FRONTEND_PUB: ${{ needs.frontend-delivery.outputs.published_image }}
        run: |
          backend_image="${BACKEND_PUB:-CURRENT}"
          frontend_image="${FRONTEND_PUB:-CURRENT}"
          
          deploy_required=false
          if [[ "$backend_image" != "CURRENT" || "$frontend_image" != "CURRENT" ]]; then
            deploy_required=true
          fi
          
          echo "backend_image=$backend_image" >> "$GITHUB_OUTPUT"
          echo "frontend_image=$frontend_image" >> "$GITHUB_OUTPUT"
          echo "deploy_required=$deploy_required" >> "$GITHUB_OUTPUT"

  deploy:
    name: Deploy Application
    needs: normalize
    if: always() && needs.normalize.result == 'success' && needs.normalize.outputs.deploy_required == 'true'
    uses: ./.github/workflows/swarm-deploy.yml
    secrets: inherit
    with:
      backend_image: ${{ needs.normalize.outputs.backend_image }}
      frontend_image: ${{ needs.normalize.outputs.frontend_image }}

  summary:
    name: Deployment Summary
    needs: [backend-delivery, frontend-delivery, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Print Summary
        run: |
          echo "Backend Delivery Result: ${{ needs.backend-delivery.result }}"
          echo "Frontend Delivery Result: ${{ needs.frontend-delivery.result }}"
          echo "Deployment Result: ${{ needs.deploy.result }}"
          echo "Backend Image: ${{ needs.normalize.outputs.backend_image }}"
          echo "Frontend Image: ${{ needs.normalize.outputs.frontend_image }}"